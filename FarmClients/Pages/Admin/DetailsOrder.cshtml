@page
@model FarmClients.Pages.Admin.DetailsProduceModel
@{
	Layout = "~/Pages/Admin/Shared/_AdminLayout.cshtml";
}

<style>
    .status-yellow {
        background-color: yellow;
        color: black;
    }

    .status-green {
        background-color: green;
        color: white;
    }

    .status-blue {
        background-color: blue;
        color: white;
    }

    .status-red {
        background-color: red;
        color: white;
    }
</style>



<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Product Details</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
    <div class="main-content">
        <div class="row">
            <div class="table-wrapper">

                <div class="table-title">
                    <div class="row">
                        <div class="col-sm-6 p-0 flex justify-content-lg-start justify-content-center">
                            <h2 class="ml-lg-2">Order</h2>
                        </div>
                        <div class="col-sm-6 p-0 flex justify-content-lg-end justify-content-center">
                            <a class="btn btn-secondary" href="/Admin/Order">
                                <span>Back to list</span>
                            </a>
                        </div>
                    </div>
                </div>
            </div>
            <table id="orderTable" class="table table-striped table-hover">
                <thead>
                    <tr>
                        <th>Id</th>
                        <th>User Name</th>
                        <th>Order Date</th>
                        <th>Status</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
            </table>

                    @* process *@
                    <div class="table-wrapper">

                        <div class="table-title">
                            <div class="row">
                                <div class="col-sm-6 p-0 flex justify-content-lg-start justify-content-center">
                                    <h2 class="ml-lg-2">Order Details</h2>
                                </div>
                                <div class="col-sm-6 p-0 flex justify-content-lg-end justify-content-center">
                                </div>
                            </div>
                        </div>
                    </div>
                    <table id="orderDetailsTable" class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>Id</th>
                                <th>Order Id</th>
                                <th>Produce Name</th>
                                <th>Quantity</th>
                                <th>Total Price</th>
                                <th>Address</th>
                            </tr>
                        </thead>
                        <tbody >
                        </tbody>
                    </table>
            
            
            <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
            <script>
                $(document).ready(function () {
                    var urlParams = new URLSearchParams(window.location.search);
                    var orderId = urlParams.get('id');

                    getOrder(orderId);
                    getAllOrderDetails(orderId);
                });

                function getOrder(orderId) {
                    $.ajax({
                        url: 'https://localhost:7020/api/Order/getBy/' + orderId,
                        type: 'GET',
                        success: function (response) {
                            if (response) {
                                var order = response;
                                $.ajax({
                                    url: 'https://localhost:7020/api/User/' + order.userId,
                                    type: 'GET',
                                    success: function (user) {
                                        console.log(user);
                                        $('#orderTable tbody').append(`
                                                <tr>
                                                    <td>${order.orderId}</td>
                                                    <td>${user.userName}</td>
                                                    <td>${formatDate(order.orderDate)}</td>
                                                    <td>${getStatusText(order.status)}</td>
                                                    <td>
                                                        <a href="#editModal" class="editModal" data-toggle="modal" onclick="editOrder(${order.orderId})">
                                                           <i class="material-icons" data-toggle="tooltip" title="Edit">&#xE254;</i>
                                                        </a>
                                                    </td>
                                                </tr>
                                            `);
                                    },
                                    error: function (xhr, status, error) {
                                        console.error(error);
                                    }
                                });
                            } else {
                                $('#orderTable tbody').append('<tr><td colspan="8">No data available</td></tr>');
                            }
                        },
                        error: function (xhr, status, error) {
                            console.error(error);
                        }
                    });
                }

                function getAllOrderDetails(orderId) {
                    $.ajax({
                        url: 'https://localhost:7020/api/Order/GetAllOrderDetialsByOrderId/' + orderId,
                        type: 'GET',
                        success: function (response) {
                            $('#orderDetailsTable tbody').empty();

                            if (response.length === 0) {
                                $('#orderDetailsTable tbody').append(`
                                    <tr>
                                        <td colspan="6">No data available</td>
                                    </tr>
                                `);
                            } else {
                                response.forEach(function (orderDetails) {
                                    $('#orderDetailsTable tbody').append(`
                                        <tr>
                                            <td>${orderDetails.orderDetailId}</td>
                                            <td>${orderDetails.orderId}</td>
                                            <td id="productName_${orderDetails.produceId}">${orderDetails.produceId}</td>
                                            <td>${orderDetails.quantity}</td>
                                            <td>${orderDetails.totalPrice}</td>
                                            <td>${orderDetails.address}</td>
                                        </tr>
                                    `);

                                    $.ajax({
                                        url: 'https://localhost:7020/api/Produce/' + orderDetails.produceId,
                                        type: 'GET',
                                        success: function (produce) {
                                            $(`#productName_${orderDetails.produceId}`).text(produce.name);
                                        },
                                        error: function (xhr, status, error) {
                                            console.error('Error:', error);
                                        }
                                    });


                                });
                            }
                        },
                        error: function (xhr, status, error) {
                            console.error(error);
                        }
                    });
                }      

            </script>

            <!----edit-modal start--------->
            <div class="modal fade" tabindex="-1" id="editModal" role="dialog">
                <div class="modal-dialog" role="document">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Edit Process</h5>
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                        <div class="modal-body">
                            <div class="form-group">
                                <input type="hidden" id="processId"> 
                                <label for="name">Name</label>
                                <input type="text" class="form-control" id="name" required>
                            </div>
                            <div class="form-group">
                                <label for="description">Description</label>
                                <input type="text" class="form-control" id="description" required>
                            </div>
                            <div class="form-group">
                                <label for="startTime">Start time</label>
                                <input type="datetime-local" class="form-control" id="startTime" required>
                            </div>
                            <div class="form-group">
                                <label for="endTime">End time</label>
                                <input type="datetime-local" class="form-control" id="endTime" required>
                            </div>
                            <div class="form-group">
                                <label for="status">Status</label>
                                <select class="form-control" id="status">
                                    <option value="1">Processing</option>
                                    <option value="2">Done</option>
                                    <option value="3">Out of date</option>
                                </select>
                            </div>
                        </div>
                        <p style="color: red; text-align: center" id="mess2"></p>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                            <button type="button" class="btn btn-success" id="btnEdit">Edit</button>
                        </div>
                    </div>
                </div>
            </div>

            <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
            <script>
                function editProcess(id) {
                    $.ajax({
                        url: 'https://localhost:7020/api/Process/' + id,
                        type: 'GET',
                        success: function (process) {
                            $('#editModal #processId').val(process.processId);
                            $('#editModal #name').val(process.name);
                            $('#editModal #description').val(process.description);
                            $('#editModal #startTime').val(process.startTime.slice(0, 16));
                            $('#editModal #endTime').val(process.endTime.slice(0, 16));
                            $('#editModal #status').val(process.status);
                        },
                        error: function (xhr, status, error) {
                            alert('Error: ' + error);
                        }
                    });
                }

                $(document).ready(function () {
                    var urlParams = new URLSearchParams(window.location.search);
                    var produceId = urlParams.get('id');

                    $('#btnEdit').click(function () {
                        var processId = $('#editModal #processId').val();
                        var name = $('#editModal #name').val();
                        var description = $('#editModal #description').val();
                        var startTime = $('#editModal #startTime').val();
                        var endTime = $('#editModal #endTime').val();
                        var status = $('#editModal #status').val();

                        if (name == null || name == '') {
                            $('#mess2').text('Name is required!');
                            return;
                        }
                        if (startTime == null || startTime == '') {
                            $('#mess2').text('StartTime is required!');
                            return;
                        }
                        if (endTime == null || endTime == '') {
                            $('#mess2').text('EndTime is required!');
                            return;
                        }
                        if (startTime > endTime) {
                            $('#mess2').text('EndTime must be greater than StartTime!');
                            return;
                        }

                        $.ajax({
                            url: 'https://localhost:7020/api/Process/update/' + processId,
                            type: 'PUT',
                            contentType: 'application/json',
                            data: JSON.stringify({
                                processId: processId,
                                name: name,
                                description: description,
                                startTime: startTime,
                                endTime: endTime,
                                status: status,
                                produceId: produceId
                            }),
                            success: function (result) {
                                alert(result);
                                window.location.href = '/Admin/DetailsProduce?id=' + produceId;
                            },
                            error: function (xhr, status, error) {
                                alert('Error: ' + error);
                            }
                        });
                    });
                });
            </script>




        <!----script--------->
        <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
        <script>
                //format date
                function formatDate(dateString) {
                    const date = new Date(dateString);
                    const year = date.getFullYear();
                    let month = (date.getMonth() + 1).toString().padStart(2, '0');
                    let day = date.getDate().toString().padStart(2, '0');
                    return `${year}-${month}-${day}`;
                }

                //get status
                function getStatusText(status) {
                    switch (status) {
                        case 1:
                            return "<span class='status-yellow'>Pending</span>";
                        case 2:
                            return "<span class='status-green'>Approved</span>";
                        case 3:
                            return "<span class='status-blue'>Delivering</span>";
                        case 4:
                            return "<span class='status-green'>Received</span>";
                        case 5:
                            return "<span class='status-red'>Cancel order</span>";
                        default:
                            return "Unknown";
                    }
                }

        </script>
</body>
</html>
