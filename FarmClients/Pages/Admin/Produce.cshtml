@page
@model FarmClients.Pages.Admin.ProduveModel
@{
	Layout = "~/Pages/Admin/Shared/_AdminLayout.cshtml";
}


<html lang="en">
<body>
			<div class="main-content">
				<div class="row">
						<div class="table-wrapper">

							<div class="table-title">
								<div class="row">
									<div class="col-sm-6 p-0 flex justify-content-lg-start justify-content-center">
										<h2 class="ml-lg-2">Manage  Produce</h2>
									</div>
									<div class="col-sm-6 p-0 flex justify-content-lg-end justify-content-center">
								<a href="#addProduceModal" class="btn btn-success" data-toggle="modal">
											<i class="material-icons">&#xE147;</i>
									<span>Add New Produce</span>
										</a>


								<button class="btn btn-danger btn-delete" data-toggle="modal">
									<i class="material-icons">&#xE15C;</i>
									<span>Delete</span>
								</button>

								<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
								<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
								<script>
									$(document).ready(function () {
										var selectedProduces = [];

										$('.checkbox').change(function () {
											var produceId = $(this).data('produceid');
											if ($(this).prop('checked')) {
												selectedProduces.push(produceId);
											} else {
												var index = selectedProduces.indexOf(produceId);
												if (index !== -1) {
													selectedProduces.splice(index, 1);
												}
											}
										});

										$('.btn-delete').click(function () {
											deleteProduces(selectedProduces);
										});
									});

									function deleteProduces(ids) {
										if (ids.length === 0) {
											alert('Please select at least one produce to delete.');
											return;
										}

										$.ajax({
											url: 'https://localhost:7020/api/Produce/delete',
											method: 'DELETE',
											contentType: 'application/json',
											data: JSON.stringify(ids),
											success: function (response) {
												console.log('Produces deleted successfully:', response);
												window.location.href = '/Admin/Produce';
											},
											error: function (error) {
												console.error('Error deleting produces:', error);
											}
										});
									}
								</script>



									</div>
								</div>
							</div>
						</div>
					<table id="employeeTable" class="table table-striped table-hover">
						<thead>
							<tr>
								<th>Id</th>
								<th>Name</th>
								<th>Description</th>
								<th>PlantingDate</th>
								<th>ExpectedHarvestDate</th>
								<th>ActualHarvestDate</th>
								<th>Quantity</th>
								<th>Status</th>
								<th>Action</th>
							</tr>
						</thead>
						<tbody>
						</tbody>
					</table>

					<style>
						.status-yellow {
							background-color: yellow;
							color: black;
						}

						.status-green {
							background-color: green;
							color: white;
						}

						.status-blue {
							background-color: blue;
							color: white;
						}

						.status-red {
							background-color: red;
							color: white;
						}
					</style>


					<script>
						fetch('https://localhost:7020/api/Produce')
							.then(response => response.json()) 
							.then(data => {
								data.forEach(produce => {
									const row = `
										<tr>
											<td>${produce.produceId}</td>
											<td>${produce.name}</td>
											<td>${produce.description}</td>
											<td>${formatDate(produce.plantingDate)}</td>
											<td>${formatDate(produce.expectedHarvestDate)}</td>
											<td>${formatDate(produce.actualHarvestDate)}</td>
											<td>${produce.quantity}</td>
											<td>${getStatusText(produce.status)}</td>
											<td>
												<a href="#viewEmployeeDetailsModal" class="view-details" data-toggle="modal">
													<i class="material-icons" data-toggle="tooltip" title="View Details">visibility</i>
												</a>

												<a href="#editEmployeeModal" class="edit" data-toggle="modal">
													<i class="material-icons" data-toggle="tooltip" title="Edit">&#xE254;</i>
												</a>
												<a href="#" class="delete" data-toggle="tooltip" title="Delete">
													<i class="material-icons" data-toggle="tooltip" title="Delete">delete</i>
												</a>
											</td>
										</tr>`;
									document.querySelector('#employeeTable tbody').insertAdjacentHTML('beforeend', row);
								});
							})
							.catch(error => console.error('There was a problem with the fetch operation:', error));

						function formatDate(dateString) {
							const date = new Date(dateString);
							const year = date.getFullYear();
							let month = (date.getMonth() + 1).toString().padStart(2, '0');
							let day = date.getDate().toString().padStart(2, '0');
							return `${year}-${month}-${day}`;
						}

						function getStatusText(status) {
							switch (status) {
								case 1:
									return "<span class='status-yellow'>Taking care</span>";
								case 2:
									return "<span class='status-green'>Harvest</span>";
								case 3:
									return "<span class='status-blue'>Preserve</span>";
								case 4:
									return "<span class='status-red'>Expired</span>";
								default:
									return "Unknown";
							}
						}

					</script>


					<!----add-modal start--------->
					<div class="modal fade" tabindex="-1" id="addProduceModal" role="dialog">
						<div class="modal-dialog" role="document">
							<div class="modal-content">
								<div class="modal-header">
									<h5 class="modal-title">Add Produce</h5>
									<button type="button" class="close" data-dismiss="modal" aria-label="Close">
										<span aria-hidden="true">&times;</span>
									</button>
								</div>
								<div class="modal-body">
										<div class="form-group">
											<label for="name">Name</label>
											<input type="text" class="form-control" id="name" required>
										</div>
										<div class="form-group">
											<label for="description">Description</label>
											<input type="text" class="form-control" id="description" required>
										</div>
										<div class="form-group">
											<label for="plantingDate">Planting Date</label>
											<input type="date" class="form-control" id="plantingDate" required>
										</div>
										<div class="form-group">
											<label for="expectedHarvestDate">Expected Harvest Date</label>
											<input type="date" class="form-control" id="expectedHarvestDate" required>
										</div>
										<div class="form-group">
											<label for="actualHarvestDate">Actual Harvest Date</label>
											<input type="date" class="form-control" id="actualHarvestDate">
										</div>										
										<div class="form-group">
											<label for="gardenId">Garden:</label>
											<select id="gardenId" name="gardenId" class="form-control"></select>
										</div>
										<div class="form-group">
											<label for="quantity">Quantity</label>
											<input type="number" class="form-control" id="quantity" required>
										</div>
										<div class="form-group">
											<label for="img">Img</label>
											<input type="text" class="form-control" id="img">
										</div>
										<div class="form-group">
											<label for="price">Price</label>
											<input type="number" class="form-control" id="price">
										</div>
									<div class="form-group">
										<label for="status">Status</label>
										<select class="form-control" id="status">
											<option value="1">Taking care</option>
											<option value="2">Harvest</option>
											<option value="3">Preserve</option>
											<option value="4">Expired</option>
										</select>
									</div>
								</div>
								<p style="color: red; text-align: center" id="mess"></p>
								<div class="modal-footer">
									<button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
									<button type="button" class="btn btn-success" id="btnAdd">Add</button>
								</div>
							</div>
						</div>
					</div>

					<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
					<script>
						$(document).ready(function () {
							LoadGarden();
							$('#btnAdd').click(function () {
								CreateProduce();
							});
						});

						function CreateProduce() {
							var req = {
								name: $("#name").val(),
								description: $("#description").val(),
								plantingDate: $("#plantingDate").val(),
								expectedHarvestDate: $("#expectedHarvestDate").val(),
								actualHarvestDate: $("#actualHarvestDate").val(),
								gardenId: $("#gardenId").val(),
								quantity: $("#quantity").val(),
								status: $("#status").val(), 
								img: $("#img").val(),
								price: $("#price").val()
							};

							if (req.name == null || req.name == '') {
								$('#mess').text('Name is required!');
								return;
							}							
							if (req.plantingDate == null || req.plantingDate == '') {
								$('#mess').text('Planting Date is required!');
								return;
							}
							if (req.expectedHarvestDate == null || req.expectedHarvestDate == '') {
								$('#mess').text('Expected Harvest Date is required!');
								return;
							}
							if (req.plantingDate > req.actualHarvestDate) {
								$('#mess').text('Actual Harvest Date must be greater than Planting Date!');
								return;
							}
							if (req.plantingDate > req.expectedHarvestDate) {
								$('#mess').text('Expected Harvest Date must be greater than Planting Date!');
								return;
							}
							if (req.quantity == null || req.quantity == '') {
								$('#mess').text('Quantity is required!');
								return;
							}
							if (req.price == null || req.price == '') {
								$('#mess').text('Price is required!');
								return;
							}

							// Gửi request AJAX để tạo sản phẩm
							$.ajax({
								url: 'https://localhost:7020/api/Produce/addProduce',
								method: 'POST',
								contentType: 'application/json',
								data: JSON.stringify(req),
								success: function (response) {
									console.log('Produce created successfully:', response);
									$('#mess').text('Produce created successfully!');
									window.location.href = '/Admin/Produce';
								},
								error: function (error) {
									$('#mess').text(error.responseText);
									console.error('Error creating produce:', error.responseText);
								}
							});
						}

						function LoadGarden() {
							$('#gardenId').empty();
							$.ajax({
								url: 'https://localhost:7020/api/Garden',
								method: 'GET',
								success: function (data) {
									$.each(data, function (i, a) {
										var option = $('<option>', {
											value: a.gardenId,
											text: a.name
										});

										$('#gardenId').append(option);
									});
								},
								error: function (error) {
									console.error('Error fetching data:', error);
								}
							});
						}
					</script>

					<!----edit-modal end--------->
					<!----edit-modal start--------->
					<div class="modal fade" tabindex="-1" id="editEmployeeModal" role="dialog">
						<div class="modal-dialog" role="document">
							<div class="modal-content">
								<div class="modal-header">
									<h5 class="modal-title">Edit Employees</h5>
									<button type="button" class="close" data-dismiss="modal" aria-label="Close">
										<span aria-hidden="true">&times;</span>
									</button>
								</div>
								<div class="modal-body">
									<div class="form-group">
										<label>Name</label>
										<input type="text" class="form-control" required>
									</div>
									<div class="form-group">
										<label>Description</label>
										<input type="text" class="form-control" required>
									</div>
									<div class="form-group">
										<label>Planting Date</label>
										<input type="date" class="form-control" required>
									</div>
									<div class="form-group">
										<label>ExpectedHarvest Date</label>
										<input type="date" class="form-control" required>
									</div>
									<div class="form-group">
										<label>ActualHarvestDate</label>
										<input type="date" class="form-control" >
									</div>
									<div class="form-group">
										<label>GardenID</label>
										<input type="number" class="form-control" required>
									</div>
									<div class="form-group">
										<label>Quantity</label>
										<input type="number" class="form-control" required>
									</div>
									<div class="form-group">
										<label>Status</label>
										<input type="number" class="form-control" required>
									</div>
									<div class="form-group">
										<label>Img</label>
										<input type="text" class="form-control">
									</div>
									<div class="form-group">
										<label>Price</label>
										<input type="number" class="form-control">
									</div>
								</div>
								<div class="modal-footer">
									<button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
									<button type="button" class="btn btn-success">Add</button>
								</div>
							</div>
						</div>
					</div>

					<!----edit-modal end--------->
					
				</div>
			</div>

	<script src="~/jsAD/jquery-3.3.1.slim.min.js"></script>
	<script src="~/jsAD/popper.min.js"></script>
	<script src="~/jsAD/bootstrap.min.js"></script>
	<script src="~/jsAD/jquery-3.3.1.min.js"></script>


	<script type="text/javascript">
		$(document).ready(function () {
			$(".xp-menubar").on('click', function () {
				$("#sidebar").toggleClass('active');
				$("#content").toggleClass('active');
			});

			$('.xp-menubar,.body-overlay').on('click', function () {
				$("#sidebar,.body-overlay").toggleClass('show-nav');
			});

		});
	</script>

	<br><br>


</body>
</html>